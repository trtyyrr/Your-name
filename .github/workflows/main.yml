name: Nexus Core - One-Click Kernel Builder
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. 极致磁盘空间清理
        run: |
          docker rmi $(docker images -q)
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /var/lib/apt/lists/*
          sudo apt-get clean

      - name: 2. 环境依赖安装
        run: |
          sudo apt-get update
          sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev libncurses5-dev libssl-dev python3-pip
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "PATH=$PATH:$HOME/bin" >> $GITHUB_ENV

      - name: 3. 配置身份验证并同步源码
        run: |
          # 核心修复：强制 Git 使用 HTTPS 并注入 GitHub 令牌
          git config --global user.email "bot@nexus.com"
          git config --global user.name "Nexus-Builder"
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://android.googlesource.com/".insteadOf "git://android.googlesource.com/"
          
          # 使用当前的 GITHUB_TOKEN 授权
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

          mkdir nexus_project && cd nexus_project
          
          # 初始化：--depth=1 减少数据量并防止拉取过旧的分支触发验证
          repo init -u https://github.com/OnePlusOSS/android_kernel_manifest_oneplus_sm8650 -b oneplus/sm8650_v_15.0.0_pad_pro --depth=1
          
          # 同步：增加 --no-clone-bundle 避免某些 CDN 导致的认证错误
          repo sync -j$(nproc) --current-branch --no-tags --no-clone-bundle --force-sync
          
          # 释放空间：同步完后删掉隐藏的 .repo 文件夹，否则 Bazel 编译空间绝对不够
          rm -rf .repo
          df -h

      - name: 4. 执行 Bazel 内核编译
        run: |
          cd nexus_project
          python3 kernel_platform/build_with_bazel.py -t sm8650 gki

      - name: 5. 整合 AnyKernel3 并打包
        if: success()
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 nexus_ak3
          cd nexus_ak3
          sed -i 's/block=\/dev\/block\/tdb/block=\/dev\/block\/by-name\/init_boot/g' anykernel.sh
          sed -i 's/is_slot_device=0/is_slot_device=1/g' anykernel.sh
          cp ../nexus_project/out/msm-kernel-sm8650-gki/dist/Image .
          rm -rf .git README.md
          zip -r9 ../Nexus_Kernel_SM8650.zip *

      - name: 6. 上传最终刷机包
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Nexus_Kernel_Flashable
          path: Nexus_Kernel_SM8650.zip
