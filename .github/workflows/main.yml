name: Kernel Build Test
on:
  workflow_dispatch:

jobs:
  test_build:
    runs-on: ubuntu-latest
    steps:
      - name: 深度清理磁盘空间 (关键)
        run: |
          docker rmi $(docker images -q)
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /var/lib/apt/lists/*
          sudo apt-get clean
          df -h

      - name: 安装依赖
        run: |
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "PATH=$PATH:$HOME/bin" >> $GITHUB_ENV

      - name: 同步源码 (限制深度以节省空间)
        run: |
          git config --global user.email "test@example.com"
          git config --global user.name "Tester"
          mkdir build_work && cd build_work
          # --depth=1 极其重要，只取最新提交
          repo init -u https://github.com/OnePlusOSS/android_kernel_manifest_oneplus_sm8650 -b oneplus/sm8650_v_15.0.0_pad_pro --depth=1
          # 只同步必须的 project，跳过不需要的库
          repo sync -j$(nproc) --current-branch --no-tags --no-clone-bundle --force-sync
          df -h

      - name: 尝试轻量化编译
        run: |
          cd build_work
          # 使用 --jobs 限制并发以减少内存压力，同时指定仅构建 Image
          python3 kernel_platform/build_with_bazel.py -t sm8650 gki --jobs=4
