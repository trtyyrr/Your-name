name: Nexus Core - SM8650 One-Click Builder
on:
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    # 授予 Actions 读取和写入权限
    permissions:
      contents: write

    steps:
      - name: 1. 极致磁盘空间清理
        run: |
          sudo docker rmi $(docker images -q)
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /var/lib/apt/lists/*
          sudo apt-get clean
          df -h

      - name: 2. 安装编译依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev libncurses5-dev libssl-dev python3-pip
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "PATH=$PATH:$HOME/bin" >> $GITHUB_ENV

      - name: 3. 源码同步 (强制 HTTPS)
        run: |
          git config --global user.email "bot@nexus.com"
          git config --global user.name "Nexus-Builder"
          # 核心修复：清除所有干扰配置，强制 HTTPS
          git config --global --unset-all url.https://github.com/.insteadOf || true
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"

          mkdir nexus_project && cd nexus_project
          # 初始化清单
          repo init -u https://github.com/OnePlusOSS/android_kernel_manifest_oneplus_sm8650 -b oneplus/sm8650_v_15.0.0_pad_pro --depth=1
          # 同步核心仓库
          repo sync -j$(nproc) --current-branch --no-tags --no-clone-bundle --force-sync
          
          # 空间防御：物理删除 .repo 文件夹以腾出 15GB+ 空间给 Bazel 缓存
          rm -rf .repo
          df -h

      - name: 4. Bazel 内核编译 (GKI Image)
        run: |
          cd nexus_project
          # 执行一加专用的 Bazel 编译脚本
          # 如果内存不足，可以尝试添加 --jobs=4 限制并发
          python3 kernel_platform/build_with_bazel.py -t sm8650 gki
          
          # 验证产物是否存在
          if [ -f "out/msm-kernel-sm8650-gki/dist/Image" ]; then
            echo "CHECK_IMAGE=true" >> $GITHUB_ENV
          else
            echo "Kernel Image not found!" && exit 1
          fi

      - name: 5. 封装 AnyKernel3 刷机包
        if: env.CHECK_IMAGE == 'true'
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 nexus_ak3
          cd nexus_ak3
          # 修改 anykernel.sh 配置：适配一加 Pad Pro 分区
          sed -i 's/block=\/dev\/block\/tdb/block=\/dev\/block\/by-name\/init_boot/g' anykernel.sh
          sed -i 's/is_slot_device=0/is_slot_device=1/g' anykernel.sh
          
          # 注入内核 Image
          cp ../nexus_project/out/msm-kernel-sm8650-gki/dist/Image .
          
          # 清理并打包
          rm -rf .git README.md
          zip -r9 ../Nexus_Kernel_SM8650_AnyKernel3.zip *

      - name: 6. 上传产物
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Nexus-Kernel-Flashable
          path: Nexus_Kernel_SM8650_AnyKernel3.zip
