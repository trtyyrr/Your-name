name: Build Nexus Rust Metamodule

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Build Rust Engine
        run: |
          # 1. 创建源码目录
          mkdir -p src
          
          # 2. 写入 Rust 核心逻辑 (修复了 mount 逻辑)
          cat <<EOF > src/main.rs
          use nix::mount::{mount, MsFlags};
          use std::fs;
          use std::path::Path;

          fn main() -> Result<(), Box<dyn std::error::Error>> {
              let modules_root = Path::new("/data/adb/modules");
              if !modules_root.exists() { return Ok(()); }
              
              println!("[NexusMeta] Rust Engine Start...");

              for entry in fs::read_dir(modules_root)? {
                  let entry = entry?;
                  let mod_path = entry.path();
                  
                  // 过滤逻辑
                  if mod_path.join("disable").exists() || mod_path.join("skip_mount").exists() {
                      continue;
                  }

                  let system_src = mod_path.join("system");
                  if system_src.is_dir() {
                      // KSU 强制规范：data 参数必须是 "KSU"
                      let _ = mount(
                          Some(&system_src),
                          "/system",
                          None::<&str>,
                          MsFlags::MS_BIND | MsFlags::MS_REC,
                          Some("KSU")
                      );
                  }
              }
              Ok(())
          }
          EOF

          # 3. 写入修正后的 Cargo.toml (显式开启 mount feature)
          cat <<EOF > Cargo.toml
          [package]
          name = "nexus_meta_engine"
          version = "0.1.0"
          edition = "2021"

          [dependencies]
          nix = { version = "0.27", features = ["mount", "fs"] }

          [[bin]]
          name = "nexus_meta_engine"
          path = "src/main.rs"

          [profile.release]
          strip = true
          opt-level = "z"
          lto = true
          EOF
          
          # 4. 执行交叉编译
          # 自动寻找 NDK 路径并设置链接器
          export PATH=$ANDROID_NDK_LATEST_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          cargo build --release --target aarch64-linux-android
        env:
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: aarch64-linux-android34-clang

      - name: Prepare Metamodule Structure
        run: |
          mkdir -p build/bin
          mkdir -p build/META-INF/com/google/android
          
          # 拷贝二进制
          cp target/aarch64-linux-android/release/nexus_meta_engine build/bin/
          
          # 核心：元模块标识 (Metamodule Identifier)
          cat <<EOF > build/module.prop
          id=nexus_meta_rust
          name=Nexus Meta-Engine (RS)
          version=v1.0
          versionCode=1
          author=Gemini
          description=High-performance Metamodule Infrastructure for KernelSU.
          metamodule=1
          EOF

          # 核心钩子：metamount.sh
          cat <<EOF > build/metamount.sh
          #!/system/bin/sh
          MODDIR="\${0%/*}"
          # 启动时执行 Rust 引擎
          \$MODDIR/bin/nexus_meta_engine
          EOF

          # 安装脚本
          cat <<EOF > build/META-INF/com/google/android/update-binary
          #!/sbin/sh
          ZIPFILE="\$3"
          MODPATH="/data/adb/modules/nexus_meta_rust"
          ui_print "- Installing Nexus Rust Meta-Engine"
          mkdir -p "\$MODPATH"
          unzip -o "\$ZIPFILE" -d "\$MODPATH"
          set_perm_recursive "\$MODPATH" 0 0 0755 0644
          set_perm "\$MODPATH/bin/nexus_meta_engine" 0 0 0755
          set_perm "\$MODPATH/metamount.sh" 0 0 0755
          EOF

      - name: Package Module
        run: |
          cd build
          zip -r ../nexus_meta_rust.zip ./*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nexus-Meta-RS-Zip
          path: nexus_meta_rust.zip