name: Build Nexus Rust Metamodule

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Install NDK & Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y zip
          echo "NDK_HOME=${ANDROID_NDK_LATEST_HOME}" >> $GITHUB_ENV

      - name: Build Rust Engine
        run: |
          # 动态创建 Cargo.toml 如果不存在
          if [ ! -f Cargo.toml ]; then
            echo '[package]' > Cargo.toml
            echo 'name = "nexus_meta_engine"' >> Cargo.toml
            echo 'version = "0.1.0"' >> Cargo.toml
            echo 'edition = "2021"' >> Cargo.toml
            echo '[dependencies]' >> Cargo.toml
            echo 'nix = "0.27"' >> Cargo.toml
          fi
          
          # 使用 cargo-ndk 或直接指定 linker 编译
          cargo build --release --target aarch64-linux-android
        env:
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: aarch64-linux-android34-clang

      - name: Prepare Metamodule Structure
        run: |
          mkdir -p build/bin
          mkdir -p build/META-INF/com/google/android
          
          # 拷贝编译产物
          cp target/aarch64-linux-android/release/nexus_meta_engine build/bin/
          
          # 写入 module.prop
          cat <<EOF > build/module.prop
          id=nexus_meta_rust
          name=Nexus Meta-Engine (RS)
          version=v1.0
          versionCode=1
          author=Gemini
          description=High-performance Rust-based Metamodule for KernelSU.
          metamodule=1
          EOF

          # 写入 metamount.sh 钩子
          cat <<EOF > build/metamount.sh
          #!/system/bin/sh
          MODDIR="\${0%/*}"
          \$MODDIR/bin/nexus_meta_engine
          EOF

          # 写入安装脚本
          cat <<EOF > build/META-INF/com/google/android/update-binary
          #!/sbin/sh
          ZIPFILE="\$3"
          MODPATH="/data/adb/modules/nexus_meta_rust"
          mkdir -p "\$MODPATH"
          unzip -o "\$ZIPFILE" -d "\$MODPATH"
          set_perm_recursive "\$MODPATH" 0 0 0755 0644
          set_perm "\$MODPATH/bin/nexus_meta_engine" 0 0 0755
          set_perm "\$MODPATH/metamount.sh" 0 0 0755
          EOF

      - name: Package Module
        run: |
          cd build
          zip -r ../nexus_meta_rust.zip ./*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nexus-Meta-RS-Zip
          path: nexus_meta_rust.zip