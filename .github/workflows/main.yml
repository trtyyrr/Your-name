name: Build Nexus Meta with WebUI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Build Rust Mounting Engine
        run: |
          mkdir -p src
          cat <<EOF > src/main.rs
          use nix::mount::{mount, MsFlags};
          use std::fs;
          use std::path::Path;
          fn main() -> Result<(), Box<dyn std::error::Error>> {
              let modules_root = Path::new("/data/adb/modules");
              if !modules_root.exists() { return Ok(()); }
              for entry in fs::read_dir(modules_root)? {
                  let entry = entry?;
                  let mod_path = entry.path();
                  if mod_path.join("disable").exists() || mod_path.join("skip_mount").exists() { continue; }
                  let system_src = mod_path.join("system");
                  if system_src.is_dir() {
                      let _ = mount(Some(&system_src), "/system", None::<&str>, MsFlags::MS_BIND | MsFlags::MS_REC, Some("KSU"));
                  }
              }
              Ok(())
          }
          EOF
          cat <<EOF > Cargo.toml
          [package]
          name = "ksu_meta_engine"
          version = "1.0.0"
          edition = "2021"
          [dependencies]
          nix = { version = "0.27", features = ["mount", "fs"] }
          [[bin]]
          name = "ksu_meta_engine"
          path = "src/main.rs"
          [profile.release]
          strip = true
          lto = true
          EOF
          export PATH=$ANDROID_NDK_LATEST_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          cargo build --release --target aarch64-linux-android
        env:
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: aarch64-linux-android34-clang

      - name: Assemble Full Structure with WebUI
        run: |
          mkdir -p build/bin
          mkdir -p build/webroot
          mkdir -p build/META-INF/com/google/android

          # --- 1. 元模块标识 ---
          cat <<EOF > build/module.prop
          id=nexus_meta_webui
          name=Nexus Ultimate Meta (RS+Web)
          version=v1.0
          versionCode=1
          author=Gemini
          description=带 WebUI 管理界面的原生 KSU 元模块基础设施。
          metamodule=1
          EOF

          # --- 2. WebUI 入口 (使用内核 API) ---
          cat <<EOF > build/webroot/index.html
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <link rel="stylesheet" type="text/css" href="/internal/insets.css" />
              <style>
                  body { font-family: sans-serif; padding: 20px; background: #f0f0f0; color: #333; }
                  .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
                  button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 8px; width: 100%; font-size: 16px; }
                  pre { background: #222; color: #0f0; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
              </style>
          </head>
          <body>
              <div class="card">
                  <h3>Nexus Meta 控制面板</h3>
                  <p id="model">正在获取设备信息...</p>
                  <button onclick="checkMounts()">查看当前挂载状态</button>
              </div>
              <div class="card">
                  <pre id="log">等待操作...</pre>
              </div>

              <script type="module">
                  import { exec, toast } from 'https://mui.kernelsu.org/lib/kernelsu.js';

                  // 获取属性示例
                  async function init() {
                      const { stdout } = await exec("getprop ro.product.model");
                      document.getElementById('model').innerText = "设备型号: " + stdout.trim();
                  }

                  window.checkMounts = async function() {
                      toast('正在查询内核挂载表...');
                      const { stdout } = await exec("mount | grep KSU");
                      document.getElementById('log').innerText = stdout || "未发现 KSU 挂载点";
                  }

                  init();
              </script>
          </body>
          </html>
          EOF

          # --- 3. 核心生命周期脚本 (保持之前的全量顺序) ---
          cat <<EOF > build/metamount.sh
          #!/system/bin/sh
          \${0%/*}/bin/ksu_meta_engine
          EOF
          
          # 其他脚本设为空模版供以后扩展
          touch build/metainstall.sh build/metauninstall.sh build/post-fs-data.sh build/service.sh build/boot-completed.sh build/customize.sh build/uninstall.sh

          # --- 4. 安装引导 (满足 #MAGISK 要求) ---
          echo "#MAGISK" > build/META-INF/com/google/android/updater-script
          cat <<EOF > build/META-INF/com/google/android/update-binary
          #!/sbin/sh
          ZIPFILE="\$3"
          MODPATH="/data/adb/modules/nexus_meta_webui"
          mkdir -p "\$MODPATH"
          unzip -o "\$ZIPFILE" -d "\$MODPATH"
          set_perm_recursive "\$MODPATH" 0 0 0755 0644
          chmod 755 "\$MODPATH/bin/ksu_meta_engine"
          find "\$MODPATH" -name "*.sh" -exec chmod 755 {} +
          EOF
          cp target/aarch64-linux-android/release/ksu_meta_engine build/bin/

      - name: Package Artifact
        run: |
          cd build
          zip -r ../nexus_meta_web.zip ./*

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: KSU-WebUI-Meta-RS
          path: nexus_meta_web.zip