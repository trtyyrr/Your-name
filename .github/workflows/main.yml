name: Build Nexus Meta Ultra (Mountify Enhanced)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Build Mountify-Style Rust Engine
        run: |
          mkdir -p src
          # 核心 Rust：实现内存拷贝、SELinux 镜像及伪装挂载
          cat <<EOF > src/main.rs
          use nix::mount::{mount, MsFlags};
          use std::fs;
          use std::process::Command;
          use std::path::{Path, PathBuf};

          fn main() -> Result<(), Box<dyn std::error::Error>> {
              let config_mode = fs::read_to_string("/data/adb/nexus_meta.mode").unwrap_or("tmpfs".to_string());
              let fake_name = fs::read_to_string("/data/adb/nexus_meta.conf").unwrap_or("mountify".to_string());
              let fake_name = fake_name.trim();

              // 1. 创建内存 tmpfs 挂载点（Mountify 核心：防止扫描 /data）
              let tmp_base = Path::new("/mnt/vendor").join(fake_name);
              if !tmp_base.exists() { fs::create_dir_all(&tmp_base)?; }
              
              let _ = mount(Some("tmpfs"), &tmp_base, Some("tmpfs"), MsFlags::empty(), Some("size=100M,mode=755"));

              let modules_root = Path::new("/data/adb/modules");
              if !modules_root.exists() { return Ok(()) }

              for entry in fs::read_dir(modules_root)? {
                  let entry = entry?;
                  let path = entry.path();
                  let mod_id = path.file_name().unwrap().to_str().unwrap();

                  // 过滤逻辑
                  if mod_id == "nexus_meta" || path.join("disable").exists() || path.join("skip_mountify").exists() {
                      continue;
                  }

                  let sys_src = path.join("system");
                  if sys_src.is_dir() {
                      // 2. 拷贝文件到 tmpfs 并镜像 SELinux (Mountify 1.1.4 逻辑)
                      let target_dir = tmp_base.join(mod_id);
                      let _ = Command::new("cp").args(["-Lrf", sys_src.to_str().unwrap(), target_dir.to_str().unwrap()]).status();
                      
                      // 使用 busybox 恢复上下文
                      let _ = Command::new("chcon").args(["--reference", "/system", target_dir.to_str().unwrap()]).status();

                      // 3. 执行 OverlayFS 挂载
                      let opts = format!("lowerdir={}", target_dir.display());
                      let _ = mount(Some("overlay"), "/system", Some("overlay"), MsFlags::empty(), Some(&opts));
                  }
              }

              // 4. 尝试清理 ext4 sysfs (Mountify 2.3 逻辑)
              let _ = Command::new("ksud").args(["kernel", "nuke-ext4-sysfs"]).status();
              
              Ok(())
          }
          EOF

          cat <<EOF > Cargo.toml
          [package]
          name = "ksu_meta_engine"
          version = "6.0.0"
          edition = "2021"
          [dependencies]
          nix = { version = "0.27", features = ["mount", "fs"] }
          [[bin]]
          name = "ksu_meta_engine"
          path = "src/main.rs"
          [profile.release]
          strip = true
          lto = true
          EOF

          export PATH=$ANDROID_NDK_LATEST_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          cargo build --release --target aarch64-linux-android
        env:
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: aarch64-linux-android34-clang

      - name: Assemble Final Package
        run: |
          mkdir -p build/bin build/webroot build/META-INF/com/google/android
          
          # 1. 核心属性
          cat <<EOF > build/module.prop
          id=nexus_meta_ultra
          name=Nexus Meta Ultra (Mountify-RS)
          version=v6.0
          versionCode=600
          author=Gemini & backslashxx
          description=基于 Mountify 逻辑重构：支持 tmpfs 镜像挂载、SELinux 属性同步、ksud 节点擦除。
          metamodule=1
          EOF

          # 2. 增强版 WebUI (集成 Mountify 配置项)
          cat <<EOF > build/webroot/index.html
          <!DOCTYPE html><html><head><meta charset="UTF-8"><link rel="stylesheet" href="/internal/insets.css">
          <style>body{font-family:sans-serif;padding:20px;background:#fdfdfd}.card{background:#fff;padding:18px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,0.05);margin-bottom:15px}
          h4{margin:0 0 10px 0;color:#1a73e8}select,input{width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:8px}
          button{width:100%;padding:14px;background:#1a73e8;color:#fff;border:none;border-radius:12px;font-weight:bold}</style></head>
          <body><div class="card"><h4>挂载模式 (Mountify 核心)</h4>
          <select id="mode"><option value="tmpfs">tmpfs (内存镜像 - 极致隐藏)</option><option value="ext4">ext4 (镜像模式 - 节省内存)</option></select>
          <input id="fname" placeholder="伪装挂载文件夹名 (默认: mountify)">
          <button onclick="save()">同步 Mountify 策略并重启</button></div>
          <div class="card"><h4>高级反检测</h4><p style="font-size:12px;color:gray;">已自动开启 ksu-nuke 节点清除及 SELinux 上下文镜像。</p></div>
          <script type="module">import { exec, toast } from 'https://mui.kernelsu.org/lib/kernelsu.js';
          window.save=async()=>{
            await exec('echo '+document.getElementById('mode').value+' > /data/adb/nexus_meta.mode');
            await exec('echo '+document.getElementById('fname').value+' > /data/adb/nexus_meta.conf');
            toast('策略已应用！请通过 KernelSU 重启生效。');
          };</script></body></html>
          EOF

          # 3. 生命周期钩子
          cat <<EOF > build/metamount.sh
          #!/system/bin/sh
          # 自动阻止原生的挂载逻辑 (Mountify 策略)
          for mod in /data/adb/modules/*; do
            if [ -d "\$mod/system" ]; then touch "\$mod/skip_mount"; fi
          done
          \${0%/*}/bin/ksu_meta_engine
          EOF

          # 4. Magisk/KSU 标识与安装逻辑
          echo "#MAGISK" > build/META-INF/com/google/android/updater-script
          cat <<EOF > build/META-INF/com/google/android/update-binary
          #!/sbin/sh
          ZIPFILE="\$3"; MODPATH="/data/adb/modules/nexus_meta_ultra"
          mkdir -p "\$MODPATH"; unzip -o "\$ZIPFILE" -d "\$MODPATH"
          set_perm_recursive "\$MODPATH" 0 0 0755 0644
          chmod 755 "\$MODPATH/bin/ksu_meta_engine"
          find "\$MODPATH" -name "*.sh" -exec chmod 755 {} +
          EOF
          cp target/aarch64-linux-android/release/ksu_meta_engine build/bin/

      - name: Package Artifact
        run: cd build && zip -r ../Nexus_Meta_Ultra_v6.zip ./*

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Nexus-Meta-Ultra-V6
          path: Nexus_Meta_Ultra_v6.zip