name: Nexus Core - One-Click Kernel Builder
on:
  workflow_dispatch: # 点击按钮即可开始

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. 极致磁盘空间清理
        run: |
          docker rmi $(docker images -q)
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /var/lib/apt/lists/*
          sudo apt-get clean

      - name: 2. 环境依赖安装
        run: |
          sudo apt-get update
          sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev libncurses5-dev libssl-dev python3-pip
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "PATH=$PATH:$HOME/bin" >> $GITHUB_ENV

      - name: 3. 同步一加 SM8650 源码
        run: |
          git config --global user.email "bot@nexus.com"
          git config --global user.name "Nexus-Builder"
          mkdir nexus_project && cd nexus_project
          # 使用深度为 1 节省空间
          repo init -u https://github.com/OnePlusOSS/android_kernel_manifest_oneplus_sm8650 -b oneplus/sm8650_v_15.0.0_pad_pro --depth=1
          repo sync -j$(nproc) --current-branch --no-tags --force-sync
          df -h

      - name: 4. 执行 Bazel 内核编译
        run: |
          cd nexus_project
          # 调用清单中的 Bazel 构建脚本，目标 sm8650 GKI
          python3 kernel_platform/build_with_bazel.py -t sm8650 gki
          # 验证 Image 是否生成
          ls -l out/msm-kernel-sm8650-gki/dist/Image

      - name: 5. 整合 AnyKernel3 并打包
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 nexus_ak3
          cd nexus_ak3
          # 配置 anykernel.sh (物理路径针对一加 Pad Pro)
          sed -i 's/block=\/dev\/block\/tdb/block=\/dev\/block\/by-name\/init_boot/g' anykernel.sh
          sed -i 's/is_slot_device=0/is_slot_device=1/g' anykernel.sh
          # 将编译好的内核物理放入 AK3 目录
          cp ../nexus_project/out/msm-kernel-sm8650-gki/dist/Image .
          # 清理无关文件并打包
          rm -rf .git README.md
          zip -r9 ../Nexus_Kernel_SM8650.zip *

      - name: 6. 上传最终刷机包
        uses: actions/upload-artifact@v4
        with:
          name: Nexus_Kernel_Flashable
          path: Nexus_Kernel_SM8650.zip
