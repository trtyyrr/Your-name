name: Build Full Engineering KSU Metamodule

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Build Rust Mounting Engine
        run: |
          mkdir -p src
          cat <<EOF > src/main.rs
          use nix::mount::{mount, MsFlags};
          use std::fs;
          use std::path::Path;

          fn main() -> Result<(), Box<dyn std::error::Error>> {
              let modules_root = Path::new("/data/adb/modules");
              if !modules_root.exists() { return Ok(()); }
              println!("[Nexus] 执行元挂载中...");
              for entry in fs::read_dir(modules_root)? {
                  let entry = entry?;
                  let mod_path = entry.path();
                  if mod_path.join("disable").exists() || mod_path.join("skip_mount").exists() { continue; }
                  let system_src = mod_path.join("system");
                  if system_src.is_dir() {
                      // 严格遵守 KSU source=KSU 规范
                      let _ = mount(Some(&system_src), "/system", None::<&str>, MsFlags::MS_BIND | MsFlags::MS_REC, Some("KSU"));
                  }
              }
              Ok(())
          }
          EOF

          cat <<EOF > Cargo.toml
          [package]
          name = "ksu_meta_engine"
          version = "1.0.0"
          edition = "2021"
          [dependencies]
          nix = { version = "0.27", features = ["mount", "fs"] }
          [[bin]]
          name = "ksu_meta_engine"
          path = "src/main.rs"
          [profile.release]
          strip = true
          lto = true
          panic = "abort"
          EOF
          
          export PATH=$ANDROID_NDK_LATEST_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          cargo build --release --target aarch64-linux-android
        env:
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: aarch64-linux-android34-clang

      - name: Assemble Full Metamodule Structure
        run: |
          mkdir -p build/bin
          mkdir -p build/META-INF/com/google/android

          # 1. module.prop (关键：必须声明 metamodule=1)
          cat <<EOF > build/module.prop
          id=nexus_full_meta
          name=Nexus Full Meta-Engine (Rust)
          version=v1.0
          versionCode=1
          author=Gemini
          description=全量原生 KernelSU 元模块基础设施，包含所有生命周期钩子。
          metamodule=1
          EOF

          # --- 核心元模块钩子 ---
          # 挂载处理引擎
          cat <<EOF > build/metamount.sh
          #!/system/bin/sh
          MODDIR="\${0%/*}"
          \$MODDIR/bin/ksu_meta_engine
          EOF

          # 接管常规模块安装
          cat <<EOF > build/metainstall.sh
          #!/system/bin/sh
          # 此脚本被 KernelSU 内置安装程序 source
          ui_print "- [Meta] 正在通过元模块安装模块..."
          EOF

          # 常规模块卸载清理
          cat <<EOF > build/metauninstall.sh
          #!/system/bin/sh
          MODULE_ID="\$1"
          echo "[Meta] 正在清理模块: \$MODULE_ID"
          EOF

          # --- 标准模块生命周期脚本 ---
          # 安装时交互脚本
          cat <<EOF > build/customize.sh
          ui_print "- 正在部署 Rust 元基础设施..."
          ui_print "- 目标架构: AArch64 (8 Gen 3)"
          EOF

          # post-fs-data 阶段 (在挂载前运行)
          cat <<EOF > build/post-fs-data.sh
          #!/system/bin/sh
          # 这里可以进行 sepolicy 注入
          EOF

          # service 阶段 (late_start)
          cat <<EOF > build/service.sh
          #!/system/bin/sh
          # 后台守护进程启动处
          EOF

          # boot-completed 阶段 (系统启动完成后)
          cat <<EOF > build/boot-completed.sh
          #!/system/bin/sh
          # 启动完成后的逻辑
          EOF

          # 元模块自卸载脚本 (当用户卸载本模块时)
          cat <<EOF > build/uninstall.sh
          #!/system/bin/sh
          # 清理本模块在 /data 下的缓存
          EOF

          # --- 放置二进制文件 ---
          cp target/aarch64-linux-android/release/ksu_meta_engine build/bin/

          # --- 安装引导脚本 ---
          cat <<EOF > build/META-INF/com/google/android/update-binary
          #!/sbin/sh
          ZIPFILE="\$3"
          MODPATH="/data/adb/modules/nexus_full_meta"
          ui_print "- 开始释放元模块文件..."
          mkdir -p "\$MODPATH"
          unzip -o "\$ZIPFILE" -d "\$MODPATH"
          # 设置所有脚本的可执行权限
          set_perm_recursive "\$MODPATH" 0 0 0755 0644
          chmod 755 "\$MODPATH/bin/ksu_meta_engine"
          find "\$MODPATH" -name "*.sh" -exec chmod 755 {} +
          EOF

      - name: Package Module
        run: |
          cd build
          zip -r ../nexus_full_meta.zip ./*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nexus-Full-Meta-Zip
          path: nexus_full_meta.zip