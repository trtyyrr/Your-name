name: Nexus Meta Assembler Enterprise (Full Lifecycle)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup NDK
        run: |
          # 自动定位 NDK 工具链
          echo "AS=$ANDROID_NDK_LATEST_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang" >> $GITHUB_ENV

      - name: Compile ASM Engine
        run: |
          mkdir -p build/bin build/lib build/META-INF/com/google/android
          
          # --- [ AArch64 汇编：直接通过 SVC 0 调用内核挂载 ] ---
          cat <<EOF > engine.S
          .arch armv8-a
          .text
          .global _start

          _start:
              // 1. 创建隔离挂载点 (mkdirat)
              mov x0, #-100
              adr x1, mnt_path
              mov x2, #0755
              mov x8, #34
              svc #0

              // 2. 挂载 tmpfs 屏蔽底层特征 (mount)
              adr x0, tmpfs_str
              adr x1, mnt_path
              adr x2, tmpfs_str
              mov x3, #0
              adr x4, opts_str
              mov x8, #40
              svc #0

              // 3. 执行核心逻辑脚本 (execve)
              adr x0, sh_path
              adr x1, args_ptr
              mov x2, #0
              mov x8, #221
              svc #0

          .data
          mnt_path:  .asciz "/mnt/vendor/mountify"
          tmpfs_str: .asciz "tmpfs"
          opts_str:  .asciz "size=128M,mode=755"
          sh_path:   .asciz "/system/bin/sh"
          arg0:      .asciz "sh"
          arg1:      .asciz "/data/adb/modules/nexus_meta/core.sh"
          .align 3
          args_ptr:  .quad arg0, arg1, 0
          EOF

          $AS -nostdlib -static -o build/bin/nexus_engine engine.S

      - name: Assemble Module Filesystem
        run: |
          # 复制 LKM 文件 (确保 8 个 .ko 文件在仓库根目录)
          cp nuke-android*.ko build/lib/ || true

          # --- [ 1. core.sh: 逻辑核心 ] ---
          cat <<EOF > build/core.sh
          #!/system/bin/sh
          MODDIR="/data/adb/modules/nexus_meta"
          MNT_BASE="/mnt/vendor/mountify"
          
          # 自动匹配内核 LKM
          KVER=\$(uname -r)
          SDK=\$(getprop ro.build.version.sdk)
          case "\$KVER" in
            *6.6*) KO="nuke-android15-6.6.ko" ;;
            *6.1*) KO="nuke-android14-6.1.ko" ;;
            *5.15*) [ "\$SDK" = "34" ] && KO="nuke-android14-5.15.ko" || KO="nuke-android13-5.15.ko" ;;
            *5.10*) [ "\$SDK" = "33" ] && KO="nuke-android13-5.10.ko" || KO="nuke-android12-5.10.ko" ;;
            *) KO="nuke-android-4.14.ko" ;;
          esac

          # 符号寻址注入并执行 Nuke
          SYM=\$(grep " ext4_unregister_sysfs" /proc/kallsyms | cut -d' ' -f1 | head -n1)
          [ ! -z "\$SYM" ] && insmod "\$MODDIR/lib/\$KO" symaddr=0x\$SYM mount_point=mountify

          # 扫描接管
          for m in /data/adb/modules/*; do
            [ "\$m" = "\$MODDIR" ] || [ ! -d "\$m/system" ] || [ -f "\$m/disable" ] && continue
            touch "\$m/skip_mount"
            ID=\$(basename "\$m")
            mkdir -p "\$MNT_BASE/\$ID"
            cp -af "\$m/system/." "\$MNT_BASE/\$ID/"
            # 同步 SELinux 解决空目录问题
            chcon -R --reference=/system "\$MNT_BASE/\$ID"
            mount -t overlay overlay -o lowerdir="\$MNT_BASE/\$ID" /system
          done
          EOF

          # --- [ 2. post-fs-data.sh ] ---
          echo -e "#!/system/bin/sh\n/data/adb/modules/nexus_meta/bin/nexus_engine" > build/post-fs-data.sh

          # --- [ 3. service.sh ] ---
          echo -e "#!/system/bin/sh\n# 模块维持后台\nwhile true; do sleep 3600; done" > build/service.sh

          # --- [ 4. boot-completed.sh ] ---
          echo -e "#!/system/bin/sh\n# 启动后残留清理\n[ -d /proc/fs/ext4/mountify ] && rm -rf /proc/fs/ext4/mountify" > build/boot-completed.sh

          # --- [ 5. customize.sh (安装脚本) ] ---
          cat <<EOF > build/customize.sh
          ui_print "- 正在验证 CPU 架构..."
          if [ "\$ARCH" != "arm64" ]; then abort "! 仅支持 AArch64 设备"; fi
          ui_print "- 正在写入汇编引擎..."
          set_perm_recursive \$MODPATH 0 0 0755 0644
          chmod 755 \$MODPATH/bin/nexus_engine
          chmod 755 \$MODPATH/*.sh
          EOF

          # --- [ 6. uninstall.sh ] ---
          cat <<EOF > build/uninstall.sh
          #!/system/bin/sh
          rm -rf /data/adb/nexus_meta*
          rm -rf /mnt/vendor/mountify
          EOF

          # --- [ 7. 补充 Magisk 规范文件 ] ---
          echo "#MAGISK" > build/META-INF/com/google/android/updater-script
          cat <<EOF > build/META-INF/com/google/android/update-binary
          #!/sbin/sh
          MODPATH="/data/adb/modules/nexus_meta"
          mkdir -p "\$MODPATH"
          unzip -o "\$3" -d "\$MODPATH"
          sh "\$MODPATH/customize.sh"
          EOF

          cat <<EOF > build/module.prop
          id=nexus_meta
          name=Nexus Meta (Assembly Pro)
          version=v12.0
          versionCode=1200
          author=Gemini
          description=【工业级元模块】纯汇编引导 + 全生命周期脚本。解决 SELinux 空目录，自动适配 8 种 LKM 驱动。
          metamodule=1
          EOF

      - name: Flashable Package
        run: cd build && zip -r ../Nexus_Meta_Industrial.zip ./*

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Nexus-Meta-ASM-Enterprise
          path: Nexus_Meta_Industrial.zip