name: Nexus Meta Ultra (AArch64 ASM Final)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup NDK
        run: |
          # 确保使用最新的 NDK 工具链
          echo "AS=$ANDROID_NDK_LATEST_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang" >> $GITHUB_ENV

      - name: Compile Ultra Assembly Engine
        run: |
          mkdir -p build/bin build/lib build/webroot build/META-INF/com/google/android
          
          # --- [ AArch64 汇编源代码 ] ---
          cat <<EOF > engine.S
          .arch armv8-a
          .text
          .align 2
          .global _start

          /* 系统调用号 (ARM64) */
          .equ SYS_MOUNT, 40
          .equ SYS_MKDIRAT, 34
          .equ SYS_EXIT, 93
          .equ SYS_EXECVE, 221
          .equ AT_FDCWD, -100

          _start:
              /* 1. 创建隔离挂载点 */
              mov x0, #AT_FDCWD
              adr x1, path_mnt
              mov x2, #0755
              mov x8, #SYS_MKDIRAT
              svc #0

              /* 2. 挂载 tmpfs */
              adr x0, str_tmpfs
              adr x1, path_mnt
              adr x2, str_tmpfs
              mov x3, #0
              adr x4, str_opts
              mov x8, #SYS_MOUNT
              svc #0

              /* 3. 执行核心 shell 逻辑脚本 */
              adr x0, path_shell
              adr x1, shell_args
              mov x2, #0
              mov x8, #SYS_EXECVE
              svc #0

          exit_err:
              mov x0, #1
              mov x8, #SYS_EXIT
              svc #0

          .data
          path_mnt:   .asciz "/mnt/vendor/mountify"
          str_tmpfs:  .asciz "tmpfs"
          str_opts:   .asciz "size=128M"
          path_shell: .asciz "/system/bin/sh"
          arg0:       .asciz "sh"
          arg1:       .asciz "/data/adb/modules/nexus_meta/core.sh"
          .align 3
          shell_args: .quad arg0, arg1, 0
          EOF

          # 编译静态二进制文件（零依赖，防检测）
          $AS -nostdlib -static -o build/bin/nexus_engine engine.S

      - name: Assemble Industrial Strength Package
        run: |
          # --- [ 修复：检查并复制 .ko 文件 ] ---
          # 假设你的 .ko 文件就在项目根目录下
          if ls nuke-android*.ko 1> /dev/null 2>&1; then
            cp nuke-android*.ko build/lib/
            echo "LKM 模块已成功复制。"
          else
            echo "错误: 未在根目录找到 nuke-android*.ko 文件！"
            echo "请确保你已经将 8 个 .ko 文件上传到了 Git 仓库根目录。"
            exit 1
          fi

          # 1. 核心逻辑脚本 (core.sh)
          cat <<EOF > build/core.sh
          #!/system/bin/sh
          MODDIR="/data/adb/modules/nexus_meta"
          FAKE_NAME="mountify"
          MNT_BASE="/mnt/vendor/\$FAKE_NAME"

          KVER=\$(uname -r)
          SDK=\$(getprop ro.build.version.sdk)
          
          # 匹配驱动逻辑
          case "\$KVER" in
            *6.6*) KO="nuke-android15-6.6.ko" ;;
            *6.1*) KO="nuke-android14-6.1.ko" ;;
            *5.15*) [ "\$SDK" = "34" ] && KO="nuke-android14-5.15.ko" || KO="nuke-android13-5.15.ko" ;;
            *5.10*) [ "\$SDK" = "33" ] && KO="nuke-android13-5.10.ko" || KO="nuke-android12-5.10.ko" ;;
            *) KO="nuke-android-4.14.ko" ;;
          esac

          # 提取内核符号地址
          SYM_ADDR=\$(grep " ext4_unregister_sysfs" /proc/kallsyms | cut -d' ' -f1)
          if [ ! -z "\$SYM_ADDR" ] && [ -f "\$MODDIR/lib/\$KO" ]; then
            insmod "\$MODDIR/lib/\$KO" symaddr=0x\$SYM_ADDR mount_point=\$FAKE_NAME
          fi

          # 元挂载与克隆逻辑
          for m in /data/adb/modules/*; do
            [ "\$m" = "\$MODDIR" ] || [ -f "\$m/disable" ] || [ ! -d "\$m/system" ] && continue
            touch "\$m/skip_mount"
            ID=\$(basename "\$m")
            TARGET="\$MNT_BASE/\$ID"
            mkdir -p "\$TARGET"
            cp -af "\$m/system/." "\$TARGET/"
            # 解决空目录问题的核心：同步 SELinux 权限
            chcon -R --reference=/system "\$TARGET"
            mount -t overlay overlay -o lowerdir="\$TARGET" /system
          done
          EOF

          # 2. 必备文件：module.prop
          cat <<EOF > build/module.prop
          id=nexus_meta
          name=Nexus Meta Ultra (ASM Edition)
          version=v10.1-ASM
          versionCode=1010
          author=Gemini
          description=纯汇编引导引擎。集成 8 种内核 Nuke 驱动。支持内存镜像克隆与 SELinux 完美同步。
          metamodule=1
          EOF

          # 3. 必备文件：service.sh (保持模块活跃)
          echo -e "#!/system/bin/sh\nwhile true; do sleep 3600; done" > build/service.sh

          # 4. 安装脚本：update-binary
          echo "#MAGISK" > build/META-INF/com/google/android/updater-script
          cat <<EOF > build/META-INF/com/google/android/update-binary
          #!/sbin/sh
          MODPATH="/data/adb/modules/nexus_meta"
          ui_print "- 正在部署 Nexus 汇编核心..."
          mkdir -p "\$MODPATH"
          unzip -o "\$3" -d "\$MODPATH"
          set_perm_recursive "\$MODPATH" 0 0 0755 0644
          chmod 755 "\$MODPATH/bin/nexus_engine"
          ui_print "- 核心已激活，准备重启。"
          EOF

          # 5. 入口文件：post-fs-data.sh
          echo -e "#!/system/bin/sh\n/data/adb/modules/nexus_meta/bin/nexus_engine" > build/post-fs-data.sh
          
          # 赋予所有脚本权限
          chmod 755 build/post-fs-data.sh build/core.sh build/service.sh build/META-INF/com/google/android/update-binary

      - name: Create Final Flashable Zip
        run: cd build && zip -r ../Nexus_Meta_Asm_Final.zip ./*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nexus-Meta-Asm-Module
          path: Nexus_Meta_Asm_Final.zip